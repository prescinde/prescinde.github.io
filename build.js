!function(){"use strict";window.htmlToElement=function(t){let e=document.createElement("template");return e.innerHTML=t.trim(),e.content.firstChild},window.AuxEvent=class{constructor(){this.event=document.createElement("e"),this.aux=new Event("e")}addListener(t,e){let n=this.event;n.addEventListener("e",(function o(){document.contains(t)?e():n.removeEventListener("e",o)}))}dispatch(){this.event.dispatchEvent(this.aux)}},window.Observable=class{constructor(t){this.variable=t,this.event=new AuxEvent}get value(){return this.variable}set value(t){this.variable=t,this.event.dispatch()}subscribe(t,e){this.event.addListener(t,e)}};let t=new Promise((t,e)=>{let n=new XMLHttpRequest;n.open("GET","data.json"),n.responseType="json",n.onload=()=>{n.status<400?t(n.response):e(n.statusText)},n.onerror=()=>e(n.statusText),n.send()});window.drugs=t.then(t=>t.drugs),window.goals=t.then(t=>t.goals),window.surveys=t.then(t=>t.surveys),window.drugSurveys=t.then(t=>t.drugSurveys),window.appMode=new Observable("register"),window.selectedDrugs=new Observable(JSON.parse(localStorage.selectedDrugs||"[]")),selectedDrugs.subscribe(document,()=>localStorage.selectedDrugs=JSON.stringify(selectedDrugs.value)),selectedDrugs.subscribe(document,()=>post("drugs",{drugs:selectedDrugs.value,timestamp:timestamp()})),window.selectedGoals=new Observable(JSON.parse(localStorage.selectedGoals||"[]")),selectedGoals.subscribe(document,()=>localStorage.selectedGoals=JSON.stringify(selectedGoals.value)),selectedGoals.subscribe(document,()=>post("goals",{goals:selectedGoals.value,timestamp:timestamp()}));const e="https://prescinde.herokuapp.com/";window.logged=new Observable(!1);let n=JSON.parse(localStorage.posponedPosts||"[]");if(window.signIn=function(){window.Android?Android.logIn():alert("Descarga la app para usar Prescinde")},window.Android){let t=setInterval(()=>{let e;(e=Android.email())&&(clearInterval(t),logged.value=e)},150)}async function o(){return Android.token()}function s(){localStorage.posponedPosts=JSON.stringify(n)}function a(t,e){n.push([t,e]),s()}function i(){if(logged.value){let t=n.length;for(let e=0;e<t;e++)post(...n.shift()),s()}}async function l(){let t=new Set,e=await window.drugSurveys;for(let n of selectedDrugs.value)for(let o of e[n])finishedSurveys.value.includes(o)||t.add(o);for(let e of JSON.parse(localStorage.pendingSurveys||"[]"))finishedSurveys.value.includes(e)||t.add(e);return[...t]}window.get=function(t){return new Promise((n,s)=>{o().then(o=>{let a=new XMLHttpRequest;a.open("GET",e+t+"?token="+o),a.responseType="json",a.onload=()=>{a.status<400?n(a.response):s(a.statusText)},a.onerror=()=>s(a.statusText),a.send()}).catch(s)})},window.post=function(t,n){o().then(o=>{let s=new XMLHttpRequest;s.open("POST",e+t+"?token="+o),s.onload=()=>{s.status>=400&&a(t,n)},s.onerror=()=>a(t,n),s.send(JSON.stringify(n))}).catch(()=>a(t,n))},i(),logged.subscribe(document,i),setInterval(i,3e5),window.timestamp=function(){return Date.now()},window.sendRegister=function(t){post("register",{type:t.type&&t.type.value||selectedDrugs.value[0],timestamp:timestamp(),situation:t.situation.value,desire:t.desire.value})},window.finishedSurveys=new Observable(JSON.parse(localStorage.finishedSurveys||"[]")),finishedSurveys.push=function(t){finishedSurveys.value.push(t),post("survey",{survey:t,timestamp:timestamp()}),finishedSurveys.event.dispatch()},finishedSurveys.subscribe(document,()=>localStorage.finishedSurveys=JSON.stringify(finishedSurveys.value)),window.pendingSurveys=new Observable(l()),pendingSurveys.add=async function(t){let e=await window.pendingSurveys.value,n=[...new Set([...e,...await t])];n.length>e.length&&(window.pendingSurveys.value=new Promise(t=>t(n)))},selectedDrugs.subscribe(document,()=>pendingSurveys.add(l())),window.surveyIndex=new Observable(0);async function r(){if(logged.value&&Date.now()-(localStorage.surveyTimestamp||0)>144e5){let t=await get("surveys"),e=t.finished.filter(t=>!finishedSurveys.value.includes(t));finishedSurveys.value.push(...e),finishedSurveys.event.dispatch();let n=t.pending.filter(t=>!finishedSurveys.value.includes(t));localStorage.pendingSurveys=JSON.stringify(n),n.length&&pendingSurveys.add(n),localStorage.surveyTimestamp=Date.now()}}function c(){window.Android&&!Android.notificationsEnabled()&&alert("Prescinde sólo es efectiva si activas las notificaciones")}function u(){return selectedDrugs.value.length>1?`<label>\n\t\t\t<select name="type" required>\n\t\t\t\t<option value="" selected>Tipo de droga</option>\n\t\t\t\t${selectedDrugs.value.map(t=>{return`<option value="${t}">${e=t,e.charAt(0).toUpperCase()+e.slice(1)}</option>`;var e}).join("")}\n\t\t\t</select>\n\t\t\t<p>Tipo de droga</p>\n\t\t</label>`:""}function d(){let t=new Date;return`${t.getHours()}:${String(t.getMinutes()).padStart(2,"0")}`}async function p(){let t=htmlToElement(`<main>\n\t\t<p class="title selection-title">Selecciona las adicciones para las que quieres usar la app</p>\n\t\t<form class="selection-form">\n\t\t\t${await async function(){return(await drugs).map(t=>`<label>\n\t\t<input type="checkbox" name="${t}" ${selectedDrugs.value.includes(t)?"checked":""}>\n\t\t<div class="checkbox"></div><span>${t}</span>\n\t</label>`).join("")}()}\n\t\t\t<button class="button">Guardar</button>\n\t\t</form>\n\t\t<p class="title selection-title">Selecciona las que encajen con tu situación</p>\n\t\t<form class="selection-form">\n\t\t\t${await async function(){return(await goals).map(t=>`<label>\n\t\t<input type="checkbox" name="${t}" ${selectedGoals.value.includes(t)?"checked":""}>\n\t\t<div class="checkbox"></div><span>${t}</span>\n\t</label>`).join("")}()}\n\t\t\t<button class="button">Guardar</button>\n\t\t</form>\n\t\t<footer class="main-footer">\n\t\t\t<a data-mode="register"><i class="fas fa-file-signature"></i></a>\n\t\t\t<a class="selected-icon"><i class="fas fa-cog"></i></a>\n\t\t</footer>\n\t\t<div class="footer-space"></div>\n\t</main>`),e=t.querySelectorAll("form");e[0].onsubmit=t=>{t.preventDefault();let n=[...new FormData(e[0]).keys()];n.length?(selectedDrugs.value=n,alert("Guardado")):alert("Debes elegir al menos una")},e[1].onsubmit=t=>{t.preventDefault();let n=[...new FormData(e[1]).keys()];n.length?(selectedGoals.value=n,alert("Guardado")):alert("Debes elegir al menos una")};for(let e of t.querySelectorAll("[data-mode]"))e.onclick=()=>appMode.value=e.getAttribute("data-mode");return t}async function m(){let t=htmlToElement(`<main class="selection-screen">\n\t\t<p class="title selection-title">Selecciona las adicciones para las que quieres usar la app</p>\n\t\t<form class="selection-form" id="selection">\n\t\t\t${await async function(){return(await drugs).map(t=>`<label>\n\t\t<input type="checkbox" name="${t}">\n\t\t<div class="checkbox"></div><span>${t}</span>\n\t</label>`).join("")}()}\n\t\t</form>\n\t\t<button class="button" form="selection">Continuar</button>\n\t</main>`),e=t.querySelector("form");return e.onsubmit=t=>{t.preventDefault();let n=[...new FormData(e).keys()];n.length?(selectedDrugs.value=n,loadScreen()):alert("Debes elegir al menos una")},t}async function v(){let t=htmlToElement(`<main class="selection-screen">\n\t\t<p class="title selection-title">Selecciona las que encajen con tu situación</p>\n\t\t<form class="selection-form" id="selection">\n\t\t\t${await async function(){return(await goals).map(t=>`<label>\n\t\t<input type="checkbox" name="${t}">\n\t\t<div class="checkbox"></div><span>${t}</span>\n\t</label>`).join("")}()}\n\t\t</form>\n\t\t<button class="button" form="selection">Continuar</button>\n\t</main>`),e=t.querySelector("form");return e.onsubmit=t=>{t.preventDefault();let n=[...new FormData(e).keys()];n.length?(selectedGoals.value=n,loadScreen()):alert("Debes elegir al menos una")},t}function f(){let t=htmlToElement(`<main class="confirmation-screen">\n\t\t<section>\n\t\t\t<p class="title confirmation-title">${notificationText.value}</p>\n\t\t</section>\n\t</main>`);return t.querySelector("section").appendChild(function(){let t;return notificationConfirmation?(t=htmlToElement('<article class="confirmation-buttons">\n\t\t\t<button class="button yes-button">Sí</button>\n\t\t\t<button class="button no-button">No</button>\n\t\t</article>'),t.querySelector(".yes-button").onclick=()=>sendAnswer("Sí"),t.querySelector(".no-button").onclick=()=>sendAnswer("No")):(t=htmlToElement('<article class="confirmation-buttons">\n\t\t\t<button class="button">Entendido</button>\n\t\t</article>'),t.querySelector(".button").onclick=()=>notificationText.value=null),t}()),t}r(),logged.subscribe(document,r),setInterval(r,3e5),window.notificationText=new Observable(null),window.notificationConfirmation=null,window.sendAnswer=function(t){post("answer",{text:notificationText.value,answer:t,timestamp:timestamp()}),notificationText.value=null},setInterval(()=>{let t;window.Android&&(t=Android.notificationText())&&(notificationConfirmation=Android.notificationConfirmation(),alert(notificationConfirmation),notificationText.value=t)},150),c(),setInterval(c,3e5);let g=0;function b(){document.querySelector(".google-form")||loadScreen()}window.loadScreen=async function(){scrollTo(0,0);let t,e=++g;t=logged.value?selectedDrugs.value.length?selectedGoals.value.length?(await pendingSurveys.value).length>surveyIndex.value?async function(){let t=await window.pendingSurveys.value,e=t[surveyIndex.value];finishedSurveys.value.includes(e)&&surveyIndex.value++;let n=htmlToElement(`<main>\n\t\t<p class="title form-title">Rellena el siguiente formulario para continuar</p>\n\t\t<p class="form-subtitle">Formulario ${surveyIndex.value+1} de ${t.length}</p>\n\t\t<iframe class="google-form" src="${(await surveys)[e]+encodeURIComponent(logged.value)}">Cargando…</iframe>\n\t</main>`),o=0;return n.querySelector("iframe").onload=()=>{++o>1&&(finishedSurveys.push(t[surveyIndex.value]),surveyIndex.value++)},n}():notificationText.value?f():"settings"==appMode.value?p():function t(){let e=htmlToElement(`<main>\n\t\t<p class="title register-title">Registra tu actividad <b>antes</b> de consumir</p>\n\t\t<form class="register-form">\n\t\t\t${u()}\n\t\t\t<label>\n\t\t\t\t<input type="text" placeholder="Hora" value="${d()}" readonly>\n\t\t\t\t<p>Hora</p>\n\t\t\t</label>\n\t\t\t<label>\n\t\t\t\t<input name="situation" type="text" placeholder="Situación">\n\t\t\t\t<p>Situación</p>\n\t\t\t</label>\n\t\t\t<label>\n\t\t\t\t<select name="desire" required>\n\t\t\t\t\t<option value="" selected>Grado de deseo</option>\n\t\t\t\t\t<option>0</option>\n\t\t\t\t\t<option>1</option>\n\t\t\t\t\t<option>2</option>\n\t\t\t\t\t<option>3</option>\n\t\t\t\t\t<option>4</option>\n\t\t\t\t\t<option>5</option>\n\t\t\t\t\t<option>6</option>\n\t\t\t\t\t<option>7</option>\n\t\t\t\t\t<option>8</option>\n\t\t\t\t\t<option>9</option>\n\t\t\t\t\t<option>10</option>\n\t\t\t\t</select>\n\t\t\t\t<p>Grado de deseo</p>\n\t\t\t</label>\n\t\t\t<button class="button">Registrar</button>\n\t\t</form>\n\t\t<footer class="main-footer">\n\t\t\t<a class="selected-icon"><i class="fas fa-file-signature"></i></a>\n\t\t\t<a data-mode="settings"><i class="fas fa-cog"></i></a>\n\t\t</footer>\n\t\t<div class="footer-space"></div>\n\t</main>`),n=e.querySelector("input"),o=setInterval(()=>{document.contains(n)?n.value=d():clearInterval(o)},3e3),s=e.querySelector("form");s.onsubmit=n=>{n.preventDefault(),sendRegister(s.elements),alert("Consumo registrado"),e.replaceWith(t())};for(let t of e.querySelectorAll("[data-mode]"))t.onclick=()=>appMode.value=t.getAttribute("data-mode");return e}():v():m():function(){let t=htmlToElement('<main class="welcome-screen">\n\t\t<section>\n\t\t\t<article>\n\t\t\t\t<p class="main-title">Prescinde</p>\n\t\t\t\t<img class="main-logo" src="images/logo.jpeg">\n\t\t\t</article>\n\t\t\t<article>\n\t\t\t\t<p class="main-msg">Inicia sesión para comenzar a superar tus adicciones</p>\n\t\t\t\t<a class="sign-in">\n\t\t\t\t\t<div><img src="images/google.svg"> Acceder con Google</div>\n\t\t\t\t</a>\n\t\t\t</article>\n\t\t</section>\n\t</main>');return t.querySelector(".sign-in").onclick=signIn,t}(),t=await t,e==g&&document.querySelector("main").replaceWith(t)},loadScreen(),logged.subscribe(document,loadScreen),appMode.subscribe(document,loadScreen),pendingSurveys.subscribe(document,b),surveyIndex.subscribe(document,loadScreen),notificationText.subscribe(document,b)}();
